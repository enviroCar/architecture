version: '3.4'
services: 
  ### Reverse Proxy
  caddy:
    build:
      context: https://github.com/abiosoft/caddy-docker.git
      dockerfile: Dockerfile-no-stats
      args:
        plugins: cors,ipfilter,realip,expires,cache
    image: ${REGISTRY}/ec-proxy/caddy
    ports:
      - 80:80
      - 443:443
    #  - 4443:4443
    volumes:
      - ./caddy/Caddyfile:/etc/Caddyfile
      - caddy-data:/root/.caddy
    command:
      - "--conf"
      - "/etc/Caddyfile"
      - "--port"
      - "443"
      - "--log"
      - "stdout"
      - "--agree=true"
    networks:
      - shared
      - base_shared
      - base_elk
      - cicd_shared
      - components_user-api
      - components_data-api
    healthcheck:
      test: wget -q https://processing.envirocar.org/ -O - > /dev/null || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  caddy-data:
    driver: local

networks:
  shared:
    driver: bridge
  base_shared:
    external: true
  base_elk:
    external: true
  cicd_shared:
    external: true
  components_user-api:
    external: true
  components_data-api:
    external: true
